* https://www.evernote.com/shard/s576/sh/7e58b450-1abe-43a8-bf82-fbf07f1db13c/049802174415b418a2e65f75b744ab72

* https://www.hiredintech.com/classrooms/system-design/lesson/55

* scalability. e.g. DB(Master-slave), sharding, Cache(Redis, Memcached), Load-balancing.


---------------------------
News Feed
---------------------------
* scenario
    - dau: daily active users
    - qps(query per second)
      1. relation with dau * freq / daily seconds
      2. relation with server.
         1 webserver 1k QPS, 1 sql 1k, 1 nosql 10k, 1 memcased nosql 1m qps

* service
  - User Service
  - Tweet Service
  - Media Service
  - Friendship Service

* storage
  - schema
  - sql: User Service, Friendship Service
  - nosql: Tweet Service
  - file system: Media Service, e.g S3

* scale
  - sharding
  - optimze
  - special case

* Pull
  - slow for read. Improve by cache

* Push - insync for push to followers
  - slow for write cause add user/follower relation into tables, but can do insync for post tweet

* Pull + Push
  - push for normal users with fewer followers
  - pull for star with lots of followers
  - 可能出现摇摆问题，吊粉

---------------------------
Database
---------------------------
* QPS
  - MySQl 1k
  - 硬盘型NoSQL数据库 MongoDB/Cassandra 10k
  - 内存型数据库 Redis/Memcached(单机) 100k - 1m QPS，
  - Redis支持数据持久化，Memcached不支持数据持久化.Redis 读写都很快的cache-through db.

* 思考读多于写和是反过来

* cache delete ; database set

* Design User System 
  - AuthService
    - Session table : login session_key 作为cookie值返回browser, then request to website including cookie. Logout will remove session from table.
    - session table 推荐存数据库而不是内存
  - UserService
  - FriendshipService
    - mutual friendship: smaller_user_id, bigger_user_id or from_user_id, to_user_id 

* SQL or NoSQL
  - SQL is mature and support much more things than NoSQL. NoSQL support higher QPS.
  - NoSQL doesn't support transactional

* Cassandra
  - insert(row_key, column_key, value)
  - row_key, column_key, value决定存在哪个database上
  - row_key: hash_key, for routing, sharding purpose，can't range query
  - column_key: sorted, support range query
  - value: 

* Scale: Single Point Failure
  - Sharding: 拆分数据存储到不同数据库
      Vertical Sharding：tables存入不同数据库
      Horizontal Sharding: put 1 table into diff dbs. Add new db machine, how to resolve data migration issue? consistent hashing.
  - Replica

---------------------------
Crawler & Typehead
---------------------------
* Web Crawler

* Scenario 
  1. how many web pages per second
  2. how long 
  3. how large 10k average size of a webpage

* Single-threaded web crawler
  - Producer Consumer Pattern, buffer 
  - bfs, remove()-> store page -> extract urls -> offer()

* multiple threaded 
  - multiple crawler + 1 URL queue
  - 3 approaches to resolve multi-threaded buffer write
    1. sleep
    2. condition variable 
    3. semaphore
  - context switch cost, port number limitation, network bottleneck

* distributed web scrawler
  - URL queue need to be very big: task table(url, state, priority, available_time )
  - Service: CrawLer, TaskService, StorageServices
  - Storage: db task table, BigTable to store web pages
  - Optimization: 
    1. distributed task tables, horizontal sharding 
    2. set available_time based on update faliture
    3. dead cycle, use quota

* Typeahead: 提示关键词
  - prefix -> top hot search keywords

* Scenario 
  - DAU 500m, QPS: 138k, Peak: QPS*3

* Service
  - QueryService: trie (in memory)
  - DataCollectionService：
    1. table keyword, hit_count -> prefix, keywords  

* distributed trie
  - can't distribute by a, b, c... cause its not averaged. Use am, ad, ac....

* log data service
  - modify trie periodically e.g. 10 min, then switch to new trie
  - probabilistic logging:  









































